<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¯è€ƒæ¯æ—¥ç‰¹è®­</title>
    <style>
        :root { --primary: #1677ff; --bg: #f5f5f5; --white: #fff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; padding-bottom: 80px; }
        .header { background: var(--white); padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .header h1 { margin: 0; font-size: 18px; color: #333; }
        .header p { margin: 5px 0 0; font-size: 12px; color: #666; }
        
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        
        /* é€‰é¡¹å¡åˆ‡æ¢ */
        .tabs { display: flex; background: #fff; padding: 5px; border-radius: 8px; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 14px; border-radius: 6px; cursor: pointer; color: #666; }
        .tab.active { background: var(--primary); color: #fff; font-weight: bold; }

        /* å†…å®¹åŒºåŸŸ */
        .content-box { display: none; }
        .content-box.active { display: block; }

        /* çŸ¥è¯†ç‚¹æ ·å¼ */
        .study-card { background: #fff; padding: 20px; border-radius: 12px; line-height: 1.8; color: #333; font-size: 15px; white-space: pre-wrap; }
        .study-card h3 { color: var(--primary); margin-top: 0; }

        /* é¢˜ç›®æ ·å¼ */
        .quiz-card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 15px; display: none; }
        .quiz-card.active { display: block; }
        .q-title { font-weight: bold; font-size: 16px; margin-bottom: 20px; }
        .option { padding: 12px 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; cursor: pointer; display: flex; }
        .option .letter { font-weight: bold; margin-right: 10px; color: var(--primary); }
        .option.selected { background: #e6f7ff; border-color: var(--primary); }
        .option.correct { background: #f6ffed; border-color: #52c41a; }
        .option.wrong { background: #fff1f0; border-color: #ff4d4f; }
        
        /* åº•éƒ¨æ§åˆ¶æ  */
        .footer-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto; }
        .btn { padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; }
        .btn-outline { background: #f0f0f0; color: #333; }
        .btn-primary { background: var(--primary); color: #fff; }
        
        .analysis-box { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 14px; display: none; border-left: 4px solid var(--primary); }
        
        #loading { text-align: center; padding: 50px; color: #999; }
    </style>
</head>
<body>

<div class="header">
    <h1 id="page-title">ğŸ“… è½¯è€ƒæ¯æ—¥ç‰¹è®­</h1>
    <p id="page-date">åŠ è½½ä¸­...</p>
</div>

<div class="container">
    <div id="loading">æ­£åœ¨è·å–ä»Šæ—¥è€ƒé¢˜...</div>

    <div id="main-app" style="display:none">
        <!-- é¡¶éƒ¨ Tab -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('study')">ğŸ“– çŸ¥è¯†æ™¨è¯»</div>
            <div class="tab" onclick="switchTab('quiz')">âœï¸ å®æˆ˜åˆ·é¢˜</div>
        </div>

        <!-- çŸ¥è¯†ç‚¹æ¨¡å— -->
        <div id="study-box" class="content-box active">
            <div class="study-card" id="knowledge-content"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="switchTab('quiz')">çœ‹å®Œå•¦ï¼Œå»åˆ·é¢˜ â”</button>
            </div>
        </div>

        <!-- åˆ·é¢˜æ¨¡å— -->
        <div id="quiz-box" class="content-box">
            <div id="quiz-container"></div>
            <!-- é¢˜ç›®ä¼šåœ¨ JS é‡Œç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- åº•éƒ¨å¯¼èˆª (ä»…åœ¨åˆ·é¢˜æ¨¡å¼æ˜¾ç¤º) -->
<div class="footer-bar" id="footer-bar" style="display:none">
    <button class="btn btn-outline" onclick="prevQ()">ä¸Šä¸€é¢˜</button>
    <span id="q-index">1 / 10</span>
    <button class="btn btn-primary" id="next-btn" onclick="nextQ()">ä¸‹ä¸€é¢˜</button>
</div>

<script>
    let currentData = null;
    let currentQIdx = 0;
    let userAnswers = {}; // è®°å½•ç”¨æˆ·ç­”æ¡ˆ

    // 1. åˆå§‹åŒ–ï¼šè·å– URL ä¸­çš„æ—¥æœŸï¼Œå» fetch å¯¹åº”çš„ JSON æ–‡ä»¶
    window.onload = async function() {
        const params = new URLSearchParams(window.location.search);
        // å¦‚æœ URL æ²¡æœ‰ date å‚æ•°ï¼Œé»˜è®¤æ‰¾ data/today.json (æˆ–è€…ä½ å¯ä»¥è®© Python ç”Ÿæˆå¸¦æ—¥æœŸçš„æ–‡ä»¶å)
        // è¿™é‡Œæˆ‘ä»¬çº¦å®šï¼šPython ä¼šæŠŠæ¯å¤©çš„æ•°æ®å­˜ä¸º docs/data/YYYY-MM-DD.json
        const dateStr = params.get('date'); 
        
        if(!dateStr) {
            document.getElementById('loading').innerText = "âŒ é“¾æ¥æ— æ•ˆï¼Œç¼ºå°‘æ—¥æœŸå‚æ•°";
            return;
        }

        try {
            // åŠ ä¸ªæ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
            const res = await fetch(`./docs/data/${dateStr}.json?t=${new Date().getTime()}`);
            if(!res.ok) throw new Error("æ–‡ä»¶ä¸å­˜åœ¨");
            currentData = await res.json();
            initApp(dateStr);
        } catch(e) {
            document.getElementById('loading').innerText = "âŒ æœªæ‰¾åˆ°ä»Šæ—¥é¢˜åº“ï¼Œè¯·ç¨åå†è¯•æˆ–æ£€æŸ¥æ—¥æœŸ";
            console.error(e);
        }
    };

    function initApp(date) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        
        document.getElementById('page-title').innerText = `ğŸ“… ${currentData.topic}`;
        document.getElementById('page-date').innerText = date;
        
        // æ¸²æŸ“çŸ¥è¯†ç‚¹ (ç®€å•çš„ Markdown å¤„ç†ï¼šæŠŠ ** åŠ ç²—ï¼Œæ¢è¡Œå¤„ç†)
        let kText = currentData.knowledge_point || "ä»Šæ—¥æ— çŸ¥è¯†ç‚¹";
        kText = kText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>'); // åŠ ç²—
        document.getElementById('knowledge-content').innerHTML = kText;

        // æ¸²æŸ“é¢˜ç›®
        const qContainer = document.getElementById('quiz-container');
        currentData.questions.forEach((q, idx) => {
            const card = document.createElement('div');
            card.className = `quiz-card ${idx === 0 ? 'active' : ''}`;
            card.id = `q-card-${idx}`;
            
            let optionsHtml = '';
            q.options.forEach((opt, oIdx) => {
                // æå–é€‰é¡¹å­—æ¯ï¼Œå¦‚ "A. xxx" -> "A"
                // å‡è®¾é€‰é¡¹æ ¼å¼æ˜¯ "A. æ–‡æœ¬"
                const letter = opt.substring(0, 1); 
                optionsHtml += `
                    <div class="option" onclick="checkAnswer(${idx}, ${oIdx}, '${letter}', this)">
                        <span class="letter">${letter}</span>
                        <span>${opt.substring(2)}</span>
                    </div>
                `;
            });

            card.innerHTML = `
                <div class="q-title">${idx + 1}. ${q.question}</div>
                <div class="options-list">${optionsHtml}</div>
                <div class="analysis-box" id="analysis-${idx}">
                    <strong>âœ… å‚è€ƒç­”æ¡ˆï¼š${q.answer}</strong><br><br>
                    ${q.analysis}
                </div>
            `;
            qContainer.appendChild(card);
        });
    }

    // åˆ‡æ¢ Tab
    window.switchTab = function(type) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-box').forEach(b => b.classList.remove('active'));
        
        if(type === 'study') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('study-box').classList.add('active');
            document.getElementById('footer-bar').style.display = 'none';
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('quiz-box').classList.add('active');
            document.getElementById('footer-bar').style.display = 'flex';
        }
    }

    // ç­”é¢˜é€»è¾‘
    window.checkAnswer = function(qIdx, oIdx, choice, el) {
        if(userAnswers[qIdx] !== undefined) return; // å·²ç­”è¿‡ä¸å¯æ”¹
        
        userAnswers[qIdx] = choice;
        const correct = currentData.questions[qIdx].answer.trim().toUpperCase();
        
        if(choice === correct) {
            el.classList.add('correct');
        } else {
            el.classList.add('wrong');
            // è‡ªåŠ¨æŠŠæ­£ç¡®çš„æ ‡ç»¿
            const options = el.parentElement.children;
            const correctIdx = ['A','B','C','D'].indexOf(correct);
            if(correctIdx >= 0 && options[correctIdx]) options[correctIdx].classList.add('correct');
        }
        
        // æ˜¾ç¤ºè§£æ
        document.getElementById(`analysis-${qIdx}`).style.display = 'block';
    }

    // ç¿»é¡µé€»è¾‘
    window.nextQ = function() {
        if(currentQIdx < currentData.questions.length - 1) {
            document.getElementById(`q-card-${currentQIdx}`).classList.remove('active');
            currentQIdx++;
            document.getElementById(`q-card-${currentQIdx}`).classList.add('active');
            updateFooter();
        } else {
            alert("å·²ç»æ˜¯æœ€åä¸€é¢˜å•¦ï¼");
        }
    }

    window.prevQ = function() {
        if(currentQIdx > 0) {
            document.getElementById(`q-card-${currentQIdx}`).classList.remove('active');
            currentQIdx--;
            document.getElementById(`q-card-${currentQIdx}`).classList.add('active');
            updateFooter();
        }
    }

    function updateFooter() {
        document.getElementById('q-index').innerText = `${currentQIdx + 1} / ${currentData.questions.length}`;
        const nextBtn = document.getElementById('next-btn');
        nextBtn.innerText = (currentQIdx === currentData.questions.length - 1) ? "å®Œæˆ" : "ä¸‹ä¸€é¢˜";
    }
</script>
</body>
</html>
